import gradio as gr
from llama_cpp import Llama
import time

print("üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Saiga Assistant...")

# –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥–µ–ª—å –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
llm = Llama(
    model_path="/home/dragon/ai_assistant/saiga-7b-Q4_K_M/saiga-7b-Q4_K_M.gguf",
    n_ctx=1024,        # –£–º–µ–Ω—å—à–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å 2048
    n_threads=6,       # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ø–æ—Ç–æ–∫–∏ CPU
    n_batch=512,       # –ë–æ–ª—å—à–µ –±–∞—Ç—á –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    verbose=False
)

print("‚úÖ –ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ!")

def chat_with_saiga(message, history):
    """–§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Å–∏—Å—Ç–µ–º–Ω—ã–º –ø—Ä–æ–º–ø—Ç–æ–º"""
    print(f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {message}")
    
    # –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ –æ—Ç–≤–µ—Ç–æ–≤
    system_prompt = "–¢—ã - –æ–ø—ã—Ç–Ω—ã–π –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç –∏ IT-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç. –û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –î–∞–≤–∞–π —á–µ—Ç–∫–∏–µ, –ø–æ–Ω—è—Ç–Ω—ã–µ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è. –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –∫–∞—Å–∞–µ—Ç—Å—è –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è - –ø—Ä–∏–≤–æ–¥–∏ –ø—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞."
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Å–∏—Å—Ç–µ–º–Ω—ã–º –ø—Ä–æ–º–ø—Ç–æ–º
    full_message = f"{system_prompt}\n\n–í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {message}\n\n–û—Ç–≤–µ—Ç:"
    
    start_time = time.time()
    response = llm(
    full_message,
    max_tokens=150,    # –°–æ–∫—Ä–∞—â–∞–µ–º –¥–ª–∏–Ω—É –æ—Ç–≤–µ—Ç–æ–≤
    temperature=0.3,
    stop=["\n\n", "–í–æ–ø—Ä–æ—Å:", "User:", "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:"]
)
    
    response_time = time.time() - start_time
    answer = response['choices'][0]['text'].strip()
    
    print(f"ü§ñ Saiga ({response_time:.1f}—Å): {answer}")
    return answer

# –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ChatInterface
interface = gr.ChatInterface(
    chat_with_saiga,
    title="ü§ñ Saiga Assistant",
    description="–†—É—Å—Å–∫–æ—è–∑—ã—á–Ω—ã–π –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –Ω–∞ –±–∞–∑–µ –º–æ–¥–µ–ª–∏ Saiga 7B"
)

print("üåê –ó–∞–ø—É—Å–∫ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞...")
print("üì± –û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ: http://localhost:7860")

interface.launch(
    server_name="0.0.0.0",
    server_port=7860,
    share=False
)

EOF


